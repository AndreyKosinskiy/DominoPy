
Option Public
Option Declare


Sub Initialize
	%REM
		Input data format encoded in base64
	%END REM
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim tempdoc As NotesDocument
	Dim doc As NotesDocument
	Dim stream As NotesStream
	Dim body As NotesMIMEEntity
	Dim header As NotesMIMEHeader
	
	Dim StringInBase64 As String
	Dim doc_identifier As String
	Dim delim As String
	Dim FileName As String
	Dim ArrayStringInBase64 As Variant
	Dim ArrayQueryes As Variant
	Dim ContentInBase64 As Variant


	
	Print "&lt;h2&gt;Start uploading!&lt;/h2&gt;"	
	Set db=session.Currentdatabase	
	Set tempdoc=db.Createdocument()
	session.ConvertMIME = False ' Do not convert MIME to rich text
	
	' get document with CGI variable, REQUEST_CONTENT ect..
	Set doc = session.DocumentContext
	
	' get all CGI variable put in file
	'Call doc.Copyallitems(tempdoc, False)

	
	
	StringInBase64 = doc.REQUEST_CONTENT(0)
	
	If  Not hasDocId(StringInBase64,"doc_identifier") Then
		
		doc_identifier = ""
		
		' get file content with header
		tempdoc.DirtyFile = StringInBase64
		
		' get file content
		ArrayStringInBase64 = Split(StringInBase64,Chr(13)&amp;Chr(10))
		ContentInBase64 = ArrayStringInBase64(3)
		
		' get file name
		ArrayStringInBase64 =  Split(ArrayStringInBase64(1),{"})
		FileName = ArrayStringInBase64(3)

		
	Else
		Dim tempArray As Variant
		delim = Mid(StringInBase64,1,36)
		ArrayStringInBase64 = Split(StringInBase64,delim)
		' 0 element in  array is blank.
		' 1 element in  array is header+content id.
		tempArray = Split(ArrayStringInBase64(1),Chr(13)&amp;Chr(10))
		doc_identifier = tempArray(2)
		' 2 element in  array is header+content file.
		tempArray = Split(ArrayStringInBase64(2),Chr(13)&amp;Chr(10))
		ContentInBase64 = tempArray(2)
		' get file name
		ArrayStringInBase64 =  Split(tempArray(0),{"})
		FileName = ArrayStringInBase64(3)
	End If


	Set stream = session.CreateStream
	Call stream.WriteText(ContentInBase64)
	
	Set body = tempdoc.CreateMIMEEntity()
	
	Set header = body.createHeader("Content-Type")
	Call header.setHeaderVal("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
	
	Set header = body.createHeader("Content-Disposition")
	Call header.setHeaderVal("attachment; filename=" &amp; FileName)
	
	Set header = body.createHeader("Content-ID")
	Call header.setHeaderVal("testforUpload.xlsx") 
	
	Call body.Setcontentfrombytes(stream, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", ENC_BASE64  )		
	'Call body.DecodeContent
	Call stream.Close
	 
	tempdoc.doc_identifier = doc_identifier
	tempdoc.ContentInBase64 = ContentInBase64
	tempdoc.FileName = FileName
	tempdoc.form="TestForm"
	Call tempdoc.save(True,False)
	session.ConvertMIME = True ' Restore conversion
	Print "&lt;h2&gt;File uploaded successfully!&lt;/h2&gt;"
End Sub




%REM
	Function hasDocId
	Description: Comments for Function
%END REM
Function hasDocId(content As String, IdItemName As String) As Boolean
	If InStr(content, IdItemName) &gt; 0 Then
		hasDocId = True
	Else
		hasDocId = False
	End If
End Function

